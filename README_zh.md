# 如果我们不使用 TCP 或 UDP 会发生什么?

交换机、网桥、路由器、负载均衡器、防火墙——这些网络设备维持着互联网的运转。它们以大多数人从未想过的方式路由、阻断、镜像、复制和去重流量。没有它们,这份文档也无法到达你手中。

但网络只是其中一层。操作系统有自己处理数据包的方式——分类、排队、执行防火墙规则、地址转换,决定什么可以通过,什么会被悄无声息地丢弃。每个部分都按照自己的规则行事,塑造着什么是"允许的",什么是不允许的。

在某个时刻,我产生了一个疑问——*如果我使用一个不存在的传输协议发送数据包会怎样?* 不是 TCP,不是 UDP,甚至不是 ICMP——而是完全虚构的东西。操作系统会让它通过吗?它会在离开我的机器之前就被拦截吗?路由器会忽略它,还是某个中间设备会立即扼杀它?它能否通过绕过常见的防火墙规则而实际上跑得更快?

不知道。

所以我必须尝试一下。

首先,我把数据包发给我自己,只是为了看看我自己的机器如何处理我编造的这个"毒药"。然后,我跨越大陆把它们发送到一台远程 Linux 机器,看看它们是否真的能到达。

# 先介绍一些背景知识
> [!NOTE]
> 如果你已经了解互联网的工作原理,可以跳过这一节。否则,请继续阅读。

但是等等——传输层协议到底是什么?

互联网不是魔法。它只是看起来像魔法而已。在底层,它是一个协议栈,每一层都将数据推送到下一层,直到它到达目的地。在应用层,你发送一个请求——加载一个网站、播放一个视频,或者做任何你想做的事。这个请求被操作系统包装在多层元数据、地址和头部中,直到它变成在网络中飞驰的原始比特流。

它的工作方式大概是这样的:
<p align="center">  <img src="./readme_assets/internet_protocols.png" alt="互联网工作原理的可视化指南,虽然画得有点烂但这正是我喜欢它的原因。"> </p>
<p align="center"><sub>这个图表 100% 正确,应该被收录到所有网络教科书中。</sub></p>

在顶层,应用程序——浏览器、游戏等等——生成请求(加载这个页面、发送这条消息、连接到这个游戏服务器)。然后请求开始在网络栈中下降,在每一层被包装、编码和寻址,直到最后只剩下飞向虚空的比特流。

每一层都扮演着一个角色。IP 分配地址并确保数据包知道它们要去哪里。链路层处理实际的传输——Wi-Fi、以太网、光纤,等等。还有更多内容,但我们现在不深入那个兔子洞。重要的是使网络通信真正可用的那一层。

**传输层**是网络开始变得有趣的地方。它是第一个真正复杂的协议层。它不仅仅是移动数据包——它管理连接,确保多个应用程序可以共享同一台机器,并决定数据应该如何流动。

这就是 **TCP**、**UDP** 及它们的奇怪表亲们所在的地方。**IP 协议**定义了一个叫做 `Protocol` 的字段。将此字段设置为 6 表示封装的数据包是 TCP,17 表示 UDP,[还有其他已定义的协议](https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers),但有些数字被故意留空以供将来使用。

但如果我们使用那些*未使用*的数字会怎样?

# 实验 #1: 发送流量..给我自己!

这个实验的变量实在太多了。我的操作系统、我的路由器、接收方的操作系统,以及天知道在公共互联网上散布着多少中间设备。在所有这些移动部件的情况下很难从实验中推断出结论——所以我想到了以下方法:首先,我将把数据包发送到*我自己的机器*,这保证了任何结果都仅仅是由于我的操作系统的行为。

首先,我设计了一个[简单的协议](./hdp_specification.md):**HDP**。具体细节不重要——重要的是它不像任何已知的协议。它是一个局外人,操作系统和网络栈没有预料到的东西。

接下来,我构建了一个[服务器,或者叫监听器](./src/server/main.rs),随便你怎么称呼。运行这段代码的机器将耐心等待任何数据包。然后我写了一个[客户端](./src/client/main.rs),运行这段代码的机器将向服务器发送 HDP 数据包。

最后,这是我将尝试的步骤:
1. 启动一个 HDP 服务器
	- 它将要求操作系统将任何协议号为 255 的数据包转发到它控制的套接字
2. 运行 HDP 客户端,向我的本地机器发送数据包
	- 客户端将要求操作系统将数据包友好地传递到 127.0.0.1
		- 操作系统配置为将目标地址为该地址的数据包交给回环[网络接口](https://en.wikipedia.org/wiki/Network_interface_controller)
			- 回环接口应该意识到:"呃..这个数据包应该直接回去?",并将其发送回我自己的机器
3. 操作系统将它们未经修改地传递给 HDP 服务器..?? 🤞

让我们开始吧。

我打开了两个 shell——一个是服务器:
```haskell
$ sudo cargo run --bin server
```

在另一个 shell 中我打开了客户端:
```haskell
$ fortune | cowsay | sudo cargo run --bin client 127.0.0.1
```

好的,让我们通过客户端发送数据包。3、2、1,然后..

服务器收到了消息!
```haskell
$ sudo cargo run --bin server
~~~ IP Header ~~~
Version: 4
IHL: 5
DSCP: 0
ECN: 0
Total Length: 58625
Identification: 36455
Flags: 0
Fragment Offset: 0
TTL: 64
Protocol: 255
Header Checksum: 0
Source IP: [127, 0, 0, 1]
Destination IP: [127, 0, 0, 1]


~~~ HDP Header & Data ~~~
Source Port: 420
Destination Port: 420
Timestamp: 1739640243546134000
Data:  _________________________________________
/ Marriage is not merely sharing the      \
| fettucine, but sharing the burden of    |
| finding the fettucine restaurant in the |
| first place.                            |
|                                         |
\ -- Calvin Trillin                       /
 -----------------------------------------
        \   ^__^
         \  (oo)\_______
            (__)\       )\/\
                ||----w |
                ||     ||
```

成功!操作系统接受了我的协议,将它回环,并将其原封不动地传递给服务器,没有发生任何意外!但在收工之前,我还有另一个问题:

如果我们重复这个实验,同时更改 IP 数据包中定义的协议号会发生什么?

我最初选择 **255** 是随意的——它是一个未使用的协议号。但如果我尝试一些更...不寻常的东西呢?我决定测试不同的协议号,包括:
- 6,分配给 **TCP** 数据包的号码
- 或 2,这是 **ICMP** 使用的协议号(即驱动 `ping` 的东西)
- 或甚至 256,一个超出 IP 协议定义边界的索引

它们能通过吗?操作系统会崩溃吗?

让我们看看:
```haskell
fortune | cowsay | sudo cargo run --bin client 127.0.0.1 # 这次循环遍历协议号
```

<details>

<summary><h2>结果</h2></summary>

| Protocol Number | Source IP (Server) | Byte Sum (Server) | Received (Server) | Succeeded (Client) | Byte sum (Client) | Failure reason (Client)                          | Time difference (μs) |
| --------------: | :----------------- | ----------------: | :---------------- | :----------------- | :---------------- | :----------------------------------------------- | -------------------: |
|               0 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   70 |
|               1 | nan                |               nan | 🤯                | 🫡                 | 373               | -                                                |                  nan |
|               2 | nan                |               nan | 🤯                | 🫡                 | 373               | -                                                |                  nan |
|               3 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   61 |
|               4 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   52 |
|               5 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   54 |
|               6 | nan                |               nan | 🤯                | 🫡                 | 373               | -                                                |                  nan |
|               7 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   77 |
|               8 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   63 |
|               9 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   66 |
|              10 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   52 |
|              11 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   52 |
|              12 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   63 |
|              13 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   63 |
|              14 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   50 |
|              15 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   80 |
|              16 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   64 |
|              17 | nan                |               nan | 🤯                | 🫡                 | 373               | -                                                |                  nan |
|              18 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   42 |
|              19 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   82 |
|              20 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   71 |
|              21 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   59 |
|              22 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   50 |
|              23 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   51 |
|              24 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   54 |
|              25 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   46 |
|              26 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   48 |
|              27 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   43 |
|              28 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   46 |
|              29 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   66 |
|              30 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   56 |
|              31 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   65 |
|              32 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   56 |
|              33 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   49 |
|              34 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   47 |
|              35 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   48 |
|              36 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   59 |
|              37 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   47 |
|              38 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   45 |
|              39 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   52 |
|              40 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   57 |
|              41 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   56 |
|              42 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   51 |
|              43 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   45 |
|              44 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   58 |
|              45 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   52 |
|              46 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   50 |
|              47 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   46 |
|              48 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   51 |
|              49 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   84 |
|              50 | nan                |               nan | 🤯                | 🤯                 | -                 | Operation not supported on socket (os error 102) |                  nan |
|              51 | nan                |               nan | 🤯                | 🤯                 | -                 | Operation not supported on socket (os error 102) |                  nan |
|              52 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   92 |
|              53 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                  115 |
|              54 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   81 |
|              55 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   83 |
|              56 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   96 |
|              57 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   71 |
|              58 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   69 |
|              59 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   80 |
|              60 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   84 |
|              61 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                  105 |
|              62 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                  109 |
|              63 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   97 |
|              64 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                  100 |
|              65 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   94 |
|              66 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                  124 |
|              67 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                  101 |
|              68 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                  100 |
|              69 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   87 |
|              70 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   95 |
|              71 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                  101 |
|              72 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   97 |
|              73 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                  111 |
|              74 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                  104 |
|              75 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                  115 |
|              76 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   96 |
|              77 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   77 |
|              78 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   65 |
|              79 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   54 |
|              80 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                  150 |
|              81 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   95 |
|              82 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   97 |
|              83 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   74 |
|              84 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   93 |
|              85 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   71 |
|              86 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   77 |
|              87 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   70 |
|              88 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   49 |
|              89 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   59 |
|              90 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   74 |
|              91 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   78 |
|              92 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   61 |
|              93 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   59 |
|              94 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   55 |
|              95 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   46 |
|              96 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   59 |
|              97 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   94 |
|              98 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   66 |
|              99 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   54 |
|             100 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   53 |
|             101 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   91 |
|             102 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                  148 |
|             103 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                  111 |
|             104 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                  119 |
|             105 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   75 |
|             106 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   52 |
|             107 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   53 |
|             108 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   52 |
|             109 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   44 |
|             110 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   59 |
|             111 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   51 |
|             112 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   45 |
|             113 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   75 |
|             114 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   91 |
|             115 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   85 |
|             116 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   84 |
|             117 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   64 |
|             118 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   24 |
|             119 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   46 |
|             120 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   62 |
|             121 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   48 |
|             122 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   50 |
|             123 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   50 |
|             124 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   49 |
|             125 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   74 |
|             126 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   54 |
|             127 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   46 |
|             128 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                  103 |
|             129 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   73 |
|             130 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   57 |
|             131 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   49 |
|             132 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   62 |
|             133 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   43 |
|             134 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   47 |
|             135 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   90 |
|             136 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                  112 |
|             137 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   94 |
|             138 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   53 |
|             139 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   57 |
|             140 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   74 |
|             141 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   64 |
|             142 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   77 |
|             143 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   77 |
|             144 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   75 |
|             145 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   77 |
|             146 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   88 |
|             147 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   96 |
|             148 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                  106 |
|             149 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   72 |
|             150 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   80 |
|             151 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   77 |
|             152 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   78 |
|             153 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   91 |
|             154 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   75 |
|             155 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   80 |
|             156 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   96 |
|             157 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                  110 |
|             158 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                  105 |
|             159 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   83 |
|             160 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   89 |
|             161 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   95 |
|             162 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                  111 |
|             163 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                  103 |
|             164 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   97 |
|             165 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   91 |
|             166 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   95 |
|             167 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   84 |
|             168 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   57 |
|             169 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   50 |
|             170 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   65 |
|             171 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   75 |
|             172 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   80 |
|             173 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   78 |
|             174 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   67 |
|             175 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   55 |
|             176 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   60 |
|             177 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   85 |
|             178 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   78 |
|             179 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   73 |
|             180 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   79 |
|             181 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   91 |
|             182 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   96 |
|             183 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   88 |
|             184 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   95 |
|             185 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   91 |
|             186 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   74 |
|             187 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   92 |
|             188 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   79 |
|             189 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   75 |
|             190 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   81 |
|             191 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   96 |
|             192 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   95 |
|             193 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   91 |
|             194 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   88 |
|             195 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   92 |
|             196 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   99 |
|             197 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   90 |
|             198 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   90 |
|             199 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                  100 |
|             200 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   96 |
|             201 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   89 |
|             202 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                  100 |
|             203 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   92 |
|             204 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                  109 |
|             205 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                  104 |
|             206 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                  108 |
|             207 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   95 |
|             208 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   96 |
|             209 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   71 |
|             210 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   76 |
|             211 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   71 |
|             212 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   78 |
|             213 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   91 |
|             214 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   97 |
|             215 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   97 |
|             216 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   93 |
|             217 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                  105 |
|             218 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   97 |
|             219 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   91 |
|             220 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   98 |
|             221 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   90 |
|             222 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                  108 |
|             223 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   92 |
|             224 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                  104 |
|             225 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                  109 |
|             226 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   94 |
|             227 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   99 |
|             228 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   94 |
|             229 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   79 |
|             230 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   84 |
|             231 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   79 |
|             232 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                  102 |
|             233 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                  101 |
|             234 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                  113 |
|             235 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   95 |
|             236 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                  100 |
|             237 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   91 |
|             238 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                  106 |
|             239 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   92 |
|             240 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   97 |
|             241 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   89 |
|             242 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   99 |
|             243 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   90 |
|             244 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   98 |
|             245 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   93 |
|             246 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   94 |
|             247 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   91 |
|             248 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   94 |
|             249 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   94 |
|             250 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   90 |
|             251 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   88 |
|             252 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   94 |
|             253 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   96 |
|             254 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   76 |
|             255 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                  nan |
|             255 | 127.0.0.1          |               373 | 🫡                | 🫡                 | 373               | -                                                |                   71 |
|             256 | nan                |               nan | 🤯                | 🤯                 | -                 | Invalid argument (os error 22)                   |                  nan |
</details>


## 这些失败是怎么回事?

大多数协议号工作正常——操作系统看到了数据包,将其回环,我的服务器收到了它,没有任何问题。但其中有几个在栈的不同点彻底*失败*了:
- **协议 1、2 和 6 在服务器端失败**。意思是:客户端成功发送了它们,但服务器从未看到它们
- **协议 50 和 51 在客户端失败**。操作系统拒绝发送它们
- **协议 256 甚至没有通过 `socket()` 调用**

但*为什么?* 是什么让操作系统对这些数据包区别对待?

## 系统调用:真正重要的是什么

我在调试这些东西时学到的最有用的调试技术之一是,在处理底层代码时,追踪进程正在进行的*系统调用*。

对于不了解的人来说,[系统调用](https://en.wikipedia.org/wiki/System_call)只是一个允许应用程序从操作系统请求特权资源的函数——无论是打开文件、分配内存,还是在我们的例子中,通过网络发送数据包。

在我的 Rust 代码中,我使用一个名为 [`socket2`](https://docs.rs/socket2/latest/socket2/index.html) 的库,它在我的操作系统提供的系统调用上实现了一个漂亮的包装。为了发送数据包,我请求一个套接字——你可以把它想象成我的代码可以写入以通过网络通信的特殊文件。

客户端会这样做:
```c
int sockfd = socket(
    AF_INET,    // 域: ARPA 互联网协议。这告诉操作系统我们对 IP 协议感兴趣
    SOCK_RAW,   // 类型: 原始套接字。操作系统通常处理传输层,但这给了我们完全控制权。
    255         // 协议: 我们循环遍历这个字段。
);
```

## 重新审视失败

**1、2 和 6:服务器从未看到它们**
这些数据包从客户端成功传输,但在我的服务器有机会查看它们之前就被拦截了。这表明操作系统内部的某些东西拦截了它们。

最初,我假设我的服务器会捕获它收到的任何原始 IP 数据包。套接字看起来像这样:
```c
int sockfd = socket(
    AF_INET,    // 互联网域
    SOCK_RAW,   // 原始套接字: 应该给我们完全控制权
    0           // 让操作系统决定协议
);
```

我期望 0 的意思是:
*"把一切都给我——TCP、UDP,不管是什么,都转发它"*

为了提供上下文,我在我的 Mac 上运行了这些实验,它运行的是 Darwin。查看[文档](https://developer.apple.com/library/archive/documentation/System/Conceptual/ManPages_iPhoneOS/man2/socket.2.html),真的没有提到协议号 = 0 的技巧。

在底层,Darwin 就像涂了很多化妆的 BSD,这意味着它继承了 BSD 的套接字行为和网络栈怪癖。凭着直觉,我查看了 **[BSD 套接字文档](https://man.openbsd.org/socket.2)**,我发现了这个令人沮丧的含糊不清的一行:

> "`protocol` 的值为 0 将让系统为请求的套接字类型选择适当的协议。"

所以,我的操作系统不是传递**所有**原始数据包,而是在默默地(而且有些随意地)过滤它们。我的服务器从未看到 ICMP (1)、IGMP (2) 或 TCP (6) 数据包——因为 Darwin 可能认为我的套接字不适合接收这些协议..或者什么的?

**50 和 51:客户端甚至无法发送它们**
在这里,操作系统直接拒绝发送数据包。这些不仅仅是任意数字——它们是 **IPSec (ESP 和 AH)** 的一部分,用于加密的 VPN 流量。我不确定_为什么_操作系统阻止了它们,但我想这是 Darwin 中某种安全功能。

**256:`socket()` 调用立即失败**
这个很简单:
- IPv4 协议字段是 8 位,这意味着有效值范围从 0 到 255
- 256 太大了——操作系统直接将其作为无效参数拒绝

这里没有什么意外。但*确实*令人惊讶的是,当我在 Linux 上尝试相同的实验时发生了什么..

在看到这些不一致性之后,我很好奇 Linux 会如何表现。所以我启动了一个 Linux 虚拟机并重新运行了实验。马上,行为就非常不同了。

运行服务器时我很快注意到 Linux 不允许将原始套接字绑定到协议 `0`——一些无效的协议号如 256 *有效*。作为参考,我在 [`results_no_server_linux_client_loopback`](./samples/results_no_server_linux_client_loopback.md) 中记录了结果。我很满意至少_一些_协议号按预期工作。

## 经验教训

自定义传输层协议是可行的,但是操作系统并不完全欢迎它们。网络栈内置了太多假设,原始套接字并不像你期望的那样原始。

我想这就是为什么大多数新协议存在于应用层的原因。工程师们不是与操作系统对抗,而是在现有的传输协议之上构建。例如,QUIC 运行在 UDP 之上,完全避免了这些问题。

如果你曾经使用原始套接字,*请*跨多个操作系统进行测试。如果 Darwin 允许你做某事,Linux 可能会关闭它。如果 Linux 对它没问题,Windows 可能会假装它不存在。即使它们声称_实现 POSIX 标准_,也真的没有通用行为。

## 下一步:回环之外会发生什么?

到目前为止,这些数据包从未离开过我的机器。现在,我想通过公共互联网发送 HDP:
- 路由器会转发它,还是会丢弃它?
- 防火墙会让它通过,还是将其标记为攻击?
- 与 TCP 相比,它会有不同的延迟吗?
- 我会不小心搞垮 DigitalOcean 的网络吗? :D

是时候找出答案了。

# 实验 #2:

起初我期望这个实验会很直接(剧透:完全不是)。怎么可能不呢..?

我计划在使用 Digital Ocean 等便宜的云提供商的机器上部署我的服务器——然后我会向它发送各种数据包,TCP、UDP、我自己的协议,应有尽有。收集有关数据包丢失、延迟等的统计数据,然后我会对不使用 TCP/UDP 的可行性得出结论。

简单!

但哦,它不是,一点也不是。并不是实验难以设置——而是让我感到困惑的是结果..它们不是我期望或准备好处理的任何东西。继续阅读看看为什么。

## 设置服务器

我在 Digital Ocean 上租了我能找到的最便宜的 VPS,然后设置了我的服务器和我需要的所有工具。很好!

让我们看看服务器在哪里..
```haskell
root@debian-s-1vcpu-512mb-10gb-fra1-01:~# curl myip.wtf
161.35.222.56
root@debian-s-1vcpu-512mb-10gb-fra1-01:~# curl ipinfo.io/161.35.222.56
{
  "ip": "161.35.222.56",
  "city": "Frankfurt am Main",
  "region": "Hesse",
  "country": "DE",
  "loc": "50.1155,8.6842",
  "org": "AS14061 DigitalOcean, LLC",
  "postal": "60306",
  "timezone": "Europe/Berlin",
  "readme": "https://ipinfo.io/missingauth"
}
```

好的,看起来实验将跨越大陆,因为我在沙特阿拉伯运行客户端,而服务器托管在法兰克福。

在进行任何深入分析之前,我想检查一下我的 Mac 和服务器之间是否有网络路径,所以我从我的 Mac `ping` 了服务器:
```haskell
❯ ping 161.35.222.56
PING 161.35.222.56 (161.35.222.56): 56 data bytes
64 bytes from 161.35.222.56: icmp_seq=0 ttl=47 time=125.364 ms
64 bytes from 161.35.222.56: icmp_seq=1 ttl=47 time=128.061 ms
64 bytes from 161.35.222.56: icmp_seq=2 ttl=47 time=177.931 ms
64 bytes from 161.35.222.56: icmp_seq=3 ttl=47 time=225.798 ms
64 bytes from 161.35.222.56: icmp_seq=4 ttl=47 time=130.101 ms
64 bytes from 161.35.222.56: icmp_seq=5 ttl=47 time=194.563 ms
64 bytes from 161.35.222.56: icmp_seq=6 ttl=47 time=159.518 ms
64 bytes from 161.35.222.56: icmp_seq=7 ttl=47 time=134.343 ms
64 bytes from 161.35.222.56: icmp_seq=8 ttl=47 time=501.139 ms
64 bytes from 161.35.222.56: icmp_seq=9 ttl=47 time=153.672 ms
64 bytes from 161.35.222.56: icmp_seq=10 ttl=47 time=137.927 ms
64 bytes from 161.35.222.56: icmp_seq=11 ttl=47 time=355.672 ms
64 bytes from 161.35.222.56: icmp_seq=12 ttl=47 time=138.777 ms
64 bytes from 161.35.222.56: icmp_seq=13 ttl=47 time=166.116 ms
64 bytes from 161.35.222.56: icmp_seq=14 ttl=47 time=288.758 ms
64 bytes from 161.35.222.56: icmp_seq=15 ttl=47 time=151.458 ms
64 bytes from 161.35.222.56: icmp_seq=16 ttl=47 time=164.025 ms
64 bytes from 161.35.222.56: icmp_seq=17 ttl=47 time=170.132 ms
64 bytes from 161.35.222.56: icmp_seq=18 ttl=47 time=279.034 ms
^C
--- 161.35.222.56 ping statistics ---
19 packets transmitted, 19 packets received, 0.0% packet loss
```

看起来它相当远,但对我来说看起来不错,让我们使用我们的新协议发送一些数据包!

首先让我们在 Digital Ocean 机器上启动服务器:
```haskell
root@debian-s-1vcpu-512mb-10gb-fra1-01:~/hdp/hdp# sudo cargo run --bin server
Listening on protocol 255
```

现在我们可以从我的 Mac 发送数据包:

```haskell
❯ fortune | cowsay | sudo cargo run --bin client 161.35.222.56
| Protocol Number | Succeeded (Client) | Time (μs) (Client) | Byte sum (Client) | Failure reason (Client) |
| 255 | 🫡 | timestamp | 563 | - |
```

数据包已发送。让我们再次检查服务器:

```haskell
root@debian-s-1vcpu-512mb-10gb-fra1-01:~/hdp/hdp# sudo cargo run --bin server
Listening on protocol 255
| Protocol Number | Time (μs) (Server) | Source IP (Server) | Byte Sum (Server) |
| --- | --- | --- |
| 255 | timestamp | my_ip | 563 |
```

太好了。看起来一切顺利,或者我是这么想的。事实上,从这里开始一切都走下坡路了。我休息了一下然后回来了。让我们再次尝试发送数据包..

```haskell
| Protocol Number | Time (μs) (Server) | Source IP (Server) | Byte Sum (Server) |
| --- | --- | --- |
| 255 | timestamp | my_ip | 563 |
```

卡住了?我看不到第二个数据包。

我按 `Ctrl+C` 并尝试再次这样做。没有结果..?那不可能是对的,会是客户端的错误吗?让我们使用 `tcpdump` 查看我设备的所有传出数据包:
```haskell
❯ sudo tcpdump -i any 'ip[9] == 255'
tcpdump: data link type PKTAP
tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
listening on any, link-type PKTAP (Apple DLT_PKTAP), snapshot length 524288 bytes
IP mac > 161.35.222.56:  reserved 427
IP mac > 161.35.222.56:  reserved 427
IP mac > 161.35.222.56:  reserved 427
IP mac > 161.35.222.56:  reserved 427
IP mac > 161.35.222.56:  reserved 427
IP mac > 161.35.222.56:  reserved 427
IP mac > 161.35.222.56:  reserved 427
IP mac > 161.35.222.56:  reserved 427
```

它们肯定离开了我的 Mac。在接收端做同样的事情怎么样?

```haskell
root@debian-s-1vcpu-512mb-10gb-fra1-01:~/hdp# tcpdump -i any 'ip[9] > 17'
tcpdump: data link type LINUX_SLL2
tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
listening on any, link-type LINUX_SLL2 (Linux cooked v2), snapshot length 262144 bytes

```

什么也没出现。

我开始怀疑我之前的结果,它们在我的 shell 中。时间戳和字节和匹配。我在想象它们吗?Linus Torvalds 本人在对我进行煤气灯操纵吗??

等等..?我的 ISP 的 [NAT 盒](https://simple.wikipedia.org/wiki/Network_address_translation)是如何转发数据包的?NAT 依赖于端口——但我的协议对它们来说只是黑魔法。

我很困惑。

非常困惑。

深入挖掘后,我发现 Digital Ocean 不支持非标准 IP 协议。

![digital_ocean_sucks](./readme_assets/ihatedigitalocean.png)

这仍然不能解释它。一个数据包是如何存活的?真的没有办法知道,我一直在撞墙试图弄清楚。

### 最后。一次。尝试

如果有任何云提供商支持非标准 IP 协议,那应该是 AWS。

我配置了两台机器。设置好它们。服务器。客户端。它工作了..!
```haskell
admin@ip-172-31-13-218:~/hdp$ sudo cargo run --bin server 255
Server is listening on SockAddr { ss_family: 2, len: 16 }, protocol: 255
| Protocol Number | Time (μs) (Server) | Source IP (Server) | Byte Sum (Server) |
| --- | --- | --- |
| 255 | timestamp | 54.153.13.186 | 33 |
| 255 | timestamp | 54.153.13.186 | 34 |
| 255 | timestamp | 54.153.13.186 | 35 |
| 255 | timestamp | 54.153.13.186 | 36 |

```

当然,服务器距离客户端只有两跳,不需要穿过可怕的互联网海洋。

<img src="./readme_assets/latency_difference_between_hdp_and_udp.png" alt="描述" style="border-radius: 15px; width: 100%;">
<p align="center"><sub>由于两台机器都在同一个数据中心,延迟以微秒为单位。</sub></p>

在各种基准测试中,HDP 和 UDP 之间的延迟差异是一致的,但可以忽略不计的 20μs。

#### 但互联网呢?

我尝试从我的 Mac 向 AWS 服务器发送数据包,我重现了上面相同的一个数据包行为。我在 [`tcpdump_tokyo_server_mac_client.md`](./samples/tcpdump_tokyo_sever_mac_client.md) 中留下了结果样本。我为所有协议发送了 1 个数据包,除了 TCP/UDP/ICMP,所有协议在第一个数据包后都停止工作。

正如预期的那样,从 Digital Ocean 机器向 AWS 机器发送或接收数据包不起作用。

没有办法确定。


# 经验教训

从技术上讲*是的*,你可以使用自己的 IP 协议。但除非你是受虐狂,否则我不建议这样做:
- 你的代码不会是可移植的,你需要支持各种操作系统
- 你的协议会在 NAT 网关和防火墙处被随机丢弃。它可能在你自己的网络上工作,但我保证它在互联网上不会工作
- 根据我的测试,使用非标准 IP 协议没有延迟改进

总结:***使用 UDP 或 TCP***

> [!TIP]
> 如果你进一步感兴趣,Hacker News 上的好人们讨论了这份文档并提供了很多见解。[在这里查看讨论](https://news.ycombinator.com/item?id=43169103)

# 更新 (2025-03-01): 如果我们尝试 IPv6 怎么样?

一些读者([这里](https://news.ycombinator.com/item?id=43169314)和[这里](https://github.com/Hawzen/hdp/issues/1#issue-2877545908))建议我尝试在 IPv6 上使用我的新协议——因为它不像 IPv4 那样使用 NAT。我很好奇,所以我试了一下。

在添加对 IPv6 的支持后,我 ssh 进入我之前在实验中使用的 AWS 服务器,并运行了服务器:
```haskell
admin@ip-172-31-2-72:~/hdp$ RUST_BACKTRACE=full sudo cargo run --bin server 6 255 # 6 表示 IPv6
| Protocol Number | Time (μs) (Server) | Source IP (Server) | Byte Sum (Server) |
| --- | --- | --- |
```

现在我从我的 Mac 运行客户端,跨越整个世界:
```haskell
❯ fortune | cowsay | sudo cargo run --bin client 200 '2600:1f1c:1cf:b1ce:f653:afc7:4650:8aa0' 255 hdp
Running `target/debug/client 2000 '2600:1f1c:1cf:b1ce:f653:afc7:4650:8aa0' 17 udp`
| Protocol Number | Succeeded (Client) | Time (μs) (Client) | Byte sum (Client) | Failure reason (Client) |
| 255 | 🫡 | 1740779795209398 | 49 | - |
| 255 | 🫡 | 1740779795413344 | 50 | - |
| 255 | 🫡 | 1740779795620781 | 51 | - |
```

然后它在服务器上出现了 `| 255 | 1740779715088323 | my_ip | 49 |`

它确实工作了!

这个实验真的是一次过山车之旅。

# 资源
- [UDP 协议规范](https://datatracker.ietf.org/doc/html/rfc768)极简到几乎好笑
- [分配用于测试的 IP 协议号](https://datatracker.ietf.org/doc/html/rfc3692#section-2.1)
- IP 协议下支持的[协议列表](https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers)非常有趣
- [这篇](https://hackaday.com/2024/09/21/when-raw-network-sockets-arent-raw-raw-sockets-in-macos-and-linux/)文章讲述了 Linux 和 FreeBSD 中原始套接字的一些差异
- 如何在 TCP 或 UDP 以外的东西上实现 NAT?[这个](https://superuser.com/a/1108226)答案非常有洞察力
